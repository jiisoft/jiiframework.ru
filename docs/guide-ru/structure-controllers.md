Контроллеры
===========

Контроллеры являются частью [MVC](https://ru.wikipedia.org/wiki/Model-View-Controller) архитектуры. Это объекты классов,
унаследованных от [[Jii.base.Controller]] и отвечающие за обработку запроса и генерирование ответа. В сущности, при
обработки запроса HTTP сервером ([[Jii.httpServer.HttpServer]]), контроллеры проанализируют входные данные, передадут их
в [модели](structure-models), вставят результаты модели в [представления](structure-views), и в конечном итоге
сгенерируют исходящие ответы.

## Действия <span id="actions"></span>

Контроллеры состоят из *действий*, которые являются основными блоками, к которым может обращаться конечный пользователь и запрашивать исполнение того или иного
функционала. В контроллере может быть одно или несколько действий.

Следующий пример показывает `post` контроллер с двумя действиями: `view` и `create`:

```js
/**
 * @class app.controllers.PostController
 * @extends Jii.base.Controller
 */
Jii.defineClass('app.controllers.PostController', /** @lends app.controllers.PostController.prototype */{

    __extends: Jii.base.Controller,

    actionView: function(context) {
        var id = context.request.get('id');
        
        return app.models.Post.findOne(id).then(function(model) {
            if (model === null) {
                context.response.setStatusCode(404);
                context.response.send();
                return;
            }
            
            context.response.data = this.render('view', {
                model: model
            });
            context.response.send();
        });
    },
    
    actionCreate: function(context) {
        var model = new app.models.Post();
        
		Jii.when.resolve().then(function() {
			// Save user
			if (context.request.isPost()) {
				model.setAttributes(context.request.post());
				return model.save();
			}
			
			return false;
		}).then(function(isSuccess) {
            if (isSuccess) {
                context.request.redirect(['view', {id: model.get('id')}]) 
            } else {
                context.response.data = this.render('create', {
                    model: model
                });
                context.response.send();
            }
		});
    }

});
```

В действии `view` (определенном методом `actionView()`), код сначала загружает [модель](structure-models)
согласно запрошенному ID модели; Если модель успешно загружена, то код отобразит ее с помощью [представления](structure-views)
под названием `view`. В противном случае будет возвращён HTTP статус 404 с пустой страницей.

В действии `create` (определенном методом `actionCreate()`), код аналогичен. Он сначала пытается загрузить [модель](structure-models)
с помощью данных из запроса и сохранить модель. Если все прошло успешно, то код перенаправляет браузер на действие `view` с ID только
что созданной модели. В противном случае он отобразит представление `create`, через которое пользователь может заполнить нужные данные.


## Маршруты <span id="routes"></span>

Конечные пользователи обращаются к действиям через так называемые *маршруты*. Маршрут &mdash; это строка, состоящая из следующих частей:

* ID модуля: он существует, только если контроллер принадлежит не приложению, а [модулю](structure-modules);
* ID контроллера: строка, которая уникально идентифицирует контроллер среди всех других контроллеров одного и того же приложения
  (или одного и того же модуля, если контроллер принадлежит модулю);
* ID действия: строка, которая уникально идентифицирует действие среди всех других действия одного и того же контроллера.

Маршруты могут иметь следующий формат:

```
ControllerID/ActionID
```

или следующий формат, если контроллер принадлежит модулю:

```
ModuleID/ControllerID/ActionID
```

## Создание действий <span id="creating-actions"></span>

Создание действий не представляет сложностей также как и объявление так называемых *методов действий* в классе контроллера. Метод действия
это *public* метод, имя которого начинается со слова `action`. Возвращаемое значение метода действия представляет собой ответные данные,
которые будут высланы конечному пользователю. Приведенный ниже код определяет два действия `index` и `hello-world`:

```js
/**
 * @class app.controllers.SiteController
 * @extends Jii.base.Controller
 */
Jii.defineClass('app.controllers.SiteController', /** @lends app.controllers.SiteController.prototype */{

    __extends: Jii.base.Controller,

    actionIndex: function(context) {
        context.response.data = this.render('index');
        context.response.send();
    },
    
    actionHelloWorld: function(context) {
        context.response.data = 'Hello World';
        context.response.send();
    }

});
```
### ID действий <span id="action-ids"></span>

В основном действие разрабатывается для какой-либо конкретной обработки ресурса. По этой причине, ID действий в основном
являются глаголами, такими как `view`, `update`, и т. д.

По-умолчанию, ID действия должен содержать только следующие символы: Английские буквы в нижнем регистре, цифры,
подчеркивания и дефисы. Дефисы в ID действий используются для разделения слов. Например, `view`, `update2`, `comment-post` являются
допустимыми ID действий, в то время как `view?`, `Update` не являются таковыми.

Вы можете создавать действия двумя способами: встроенные действия и отдельные действия. Встроенное действие является методом, определенным
в классе контроллера, в то время как отдельное действие является экземпляром класса, унаследованного от [[Jii.base.Action]] или его потомков.
Встроенные действия требуют меньше усилий для создания и в основном используются если у вас нет надобности в повторном использовании действий.
Отдельные действия, с другой стороны, в основном создаются для использования в различных контроллерах или при использовании в расширениях.


### Встроенные действия <span id="inline-actions"></span>

Встроенные действия это те действия, которые определены в рамках методов контроллера, как мы это уже обсудили.

Названия методов действий могут быть получены из ID действий следующим образом:

* Привести первый символ каждого слова в ID действия в верхний регистр;
* Убрать дефисы;
* Добавить префикс `action`.

Например, `index` соответствует `actionIndex`, а `hello-world` соответствует `actionHelloWorld`.

> Примечание: Названия имен действий являются *регистрозависимыми*. Если у вас есть метод `ActionIndex`, он не будет
  учтен как метод действия, таким образом, запрос к действию `index` приведет к выбросу исключению. Также следует учесть, что методы действий
  должны иметь область видимости public.

Встроенные действия в основном используются, потому что для их создания не нужного много усилий. Тем не менее, если вы планируете повторно
использовать некоторые действия в различных местах, или если вы хотите перераспределить действия, вы должны определить его как *отдельной действие*.


### Отдельные действия <span id="standalone-actions"></span>

Отдельные действия определяются в качестве классов, унаследованных от [[Jii.base.Action]] или его потомков.

Для использования отдельного действия, вы должны указать его в *карте действий*, с помощью переопределения метода
[[Jii.base.Controller.actions()]] в вашем классе контроллера, следующим образом:

```js
actions: function() {
    return {
        // объявляет "error" действие с помощью названия класса
        error: 'app.actions.ErrorAction',

        // объявляет "view" действие с помощью конфигурационного объекта
        view: {
            className: 'app.actions.ViewAction',
            viewPrefix: ''
        }
    };
}
```

Как вы можете видеть, метод `actions()` должен вернуть объект, ключами которого являются ID действий, а значениями - соответствующие
названия класса действия или [конфигурация](concept-configurations). В отличие от встроенных действий, ID отдельных действий могут
содержать произвольные символы, до тех пор пока они определены в методе `actions()`.

Для создания отдельного действия, вы должны наследоваться от класса [[Jii.base.Action]] или его потомков, и реализовать
публичный метод `run()`. Роль метода `run()` аналогична другим методам действий. Например,

```js
/**
 * @class app.components.HelloWorldAction
 * @extends Jii.base.Action
 */
Jii.defineClass('app.components.HelloWorldAction', /** @lends app.components.HelloWorldAction.prototype */{

    __extends: Jii.base.Action,

    run: function(context) {
        context.response.data = 'Hello World';
        context.response.send();
    }

});
```
